/**
 *  @license
 *  Copyright CERN and copyright holders of ALICE O2. This software is
 *  distributed under the terms of the GNU General Public License v3 (GPL
 *  Version 3), copied verbatim in the file "COPYING".
 *
 *  See http://alice-o2.web.cern.ch/license for full licensing information.
 *
 *  In applying this license CERN does not waive the privileges and immunities
 *  granted to it by virtue of its status as an Intergovernmental Organization
 *  or submit itself to any jurisdiction.
 */
import { LogCreationModel } from './LogCreationModel.js';
import { OnCallLogTemplate } from './OnCallLogTemplate.js';

/**
 * @typedef OnCallLogTemplateFormData
 * @property {string} shortDescription
 * @property {string} detectorOrSubsystem
 * @property {string} severity
 * @property {string} scope
 * @property {string} shifterName
 * @property {string} shifterPosition
 * @property {string} lhcBeamMode
 * @property {string} issueDescription
 * @property {string} reason
 * @property {string} alreadyTakenActions
 */

// Only one template for now
/**
 * @typedef {OnCallLogTemplate} LogTemplate
 */

/**
 * @typedef {'on-call'} logTemplateKey
 */

/**
 * Return a new instance of log template for the given key
 *
 * @param {logTemplateKey} key the template key
 * @return {LogTemplate|null} the new log template
 */
const logTemplatesFactory = (key) => {
    const templateClass = { ['on-call']: OnCallLogTemplate }[key] ?? null;
    if (templateClass) {
        return new templateClass();
    }
    return null;
};

/**
 * Log creation model based on templates
 */
export class TemplatedLogCreationModel extends LogCreationModel {
    /**
     * Constructor
     *
     * @param {function} [onCreation] function called when log is created, with the id of the created log
     * @param {LogCreationRelations} relations the relations of the log
     */
    constructor(onCreation, relations) {
        super(onCreation, relations);

        /**
         * @type {logTemplateKey|null}
         * @private
         */
        this._templateKey = null;

        /**
         * @type {LogTemplate|null}
         * @private
         */
        this._templateModel = null;
    }

    /**
     * Defines the template to use, defined by its key
     *
     * @param {logTemplateKey|null} key the key of the template to use (there may be no model for the given key)
     * @return {void}
     */
    useTemplate(key) {
        const templateModel = logTemplatesFactory(key);
        if (templateModel) {
            templateModel.bubbleTo(this);
        }
        this._templateModel = templateModel;
        this._templateKey = key;
        this.notify();
    }

    /**
     * Set the current template key
     *
     * @return {logTemplateKey} the current key
     */
    get templateKey() {
        return this._templateKey;
    }

    /**
     * Return the current template model
     *
     * @return {LogTemplate|null} the template model
     */
    get templateModel() {
        return this._templateModel;
    }

    /**
     * States if the log creation is valid
     *
     * @return {boolean} true if the form is valid
     */
    get isValid() {
        return this._templateModel?.isValid ?? super.isValid;
    }

    /*
     * Return log properties generated by the current template if it exists, else return the parent's property
     */

    // eslint-disable-next-line valid-jsdoc
    /**
     * @inheritDoc
     */
    get title() {
        return this._templateModel?.title ?? super.title;
    }

    // eslint-disable-next-line valid-jsdoc
    /**
     * @inheritDoc
     */
    get text() {
        return this._templateModel?.text ?? super.text;
    }

    // eslint-disable-next-line valid-jsdoc
    /**
     * @inheritDoc
     */
    get runNumbers() {
        return this._templateModel?.runNumbers ?? super.runNumbers;
    }

    // eslint-disable-next-line valid-jsdoc
    /**
     * @inheritDoc
     */
    get environments() {
        return this._templateModel?._environments ?? super.environments;
    }

    // eslint-disable-next-line valid-jsdoc
    /**
     * @inheritDoc
     */
    get lhcFills() {
        return this._templateModel?.lhcFills ?? super.lhcFills;
    }

    // eslint-disable-next-line valid-jsdoc
    /**
     * @inheritDoc
     */
    get attachments() {
        return this._templateModel?._attachments ?? super.attachments;
    }
}
