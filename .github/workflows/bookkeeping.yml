name: Bookkeeping

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  test_unit:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Build and Start Unit Test Database
        run: |
          docker compose \
          -f docker-compose.test-parallel.yml \
          up --detach unit_db
      - name: Build Unit Test Container
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          build unit_tests
      - name: Run Unit Tests
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          run --rm unit_tests
      - name: Clean Up
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          down

#  test_api:
#    runs-on: ubuntu-latest
#    timeout-minutes: 20
#
#    steps:
#      - uses: actions/checkout@v4
#      - name: Set up Docker
#        uses: docker/setup-buildx-action@v2
#
#      - name: Build and Start API Test Database
#        run: |
#          docker compose \
#          -f docker-compose.test-parallel.yml \
#          up --detach api_db
#      - name: Build API Test Container
#        run: |
#          docker-compose \
#          -f docker-compose.test-parallel.yml \
#          build api_tests
#      - name: Run API Tests
#        run: |
#          docker-compose \
#          -f docker-compose.test-parallel.yml \
#          run --rm api_tests
#      - name: Clean Up
#        run: |
#          docker-compose \
#          -f docker-compose.test-parallel.yml \
#          down

  lhc_periods_tests:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker
        uses: docker/setup-buildx-action@v2
      - name: Build and Start LHC Periods Test Database
        run: |
          docker compose \
          -f docker-compose.test-parallel.yml \
          up --detach lhc_periods_db
      - name: Build LHC Periods Test Container
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          build lhc_periods_tests
      - name: Run LHC Periods Tests
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          run --rm lhc_periods_tests
      - name: Clean Up
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          down

  lhc_fills_tests:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker
        uses: docker/setup-buildx-action@v2
      - name: Build and Start LHC Fills Test Database
        run: |
          docker compose \
          -f docker-compose.test-parallel.yml \
          up --detach lhc_fills_db
      - name: Build LHC Fills Test Container
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          build lhc_fills_tests
      - name: Run LHC Fills Tests
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          run --rm lhc_fills_tests
      - name: Clean Up
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          down

#  logs_tests:
#    runs-on: ubuntu-latest
#    timeout-minutes: 20
#    steps:
#      - uses: actions/checkout@v4
#      - name: Set up Docker
#        uses: docker/setup-buildx-action@v2
#      - name: Build and Start Logs Test Database
#        run: |
#          docker compose \
#          -f docker-compose.test-parallel.yml \
#          up --detach logs_db
#      - name: Build Logs Test Container
#        run: |
#          docker-compose \
#          -f docker-compose.test-parallel.yml \
#          build logs_tests
#      - name: Run Logs Tests
#        run: |
#          docker-compose \
#          -f docker-compose.test-parallel.yml \
#          run --rm logs_tests
#      - name: Clean Up
#        run: |
#          docker-compose \
#          -f docker-compose.test-parallel.yml \
#          down

  envs_tests:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker
        uses: docker/setup-buildx-action@v2
      - name: Build and Start Envs Test Database
        run: |
          docker compose \
          -f docker-compose.test-parallel.yml \
          up --detach envs_db
      - name: Build Envs Test Container
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          build envs_tests
      - name: Run Envs Tests
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          run --rm envs_tests
      - name: Clean Up
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          down

  runs_tests:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker
        uses: docker/setup-buildx-action@v2
      - name: Build and Start Runs Test Database
        run: |
          docker compose \
          -f docker-compose.test-parallel.yml \
          up --detach runs_db
      - name: Build Runs Test Container
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          build runs_tests
      - name: Run Runs Tests
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          run --rm runs_tests
      - name: Clean Up
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          down

  subsystems_tests:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker
        uses: docker/setup-buildx-action@v2
      - name: Build and Start Subsystems Test Database
        run: |
          docker compose \
          -f docker-compose.test-parallel.yml \
          up --detach subsystems_db
      - name: Build Subsystems Test Container
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          build subsystems_tests
      - name: Run Subsystems Tests
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          run --rm subsystems_tests
      - name: Clean Up
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          down

  tags_tests:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker
        uses: docker/setup-buildx-action@v2
      - name: Build and Start Tags Test Database
        run: |
          docker compose \
          -f docker-compose.test-parallel.yml \
          up --detach tags_db
      - name: Build Tags Test Container
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          build tags_tests
      - name: Run Tags Tests
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          run --rm tags_tests
      - name: Clean Up
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          down

  flp_tests:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker
        uses: docker/setup-buildx-action@v2
      - name: Build and Start FLP Test Database
        run: |
          docker compose \
          -f docker-compose.test-parallel.yml \
          up --detach flp_db
      - name: Build FLP Test Container
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          build flp_tests
      - name: Run FLP Tests
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          run --rm flp_tests
      - name: Clean Up
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          down

  home_tests:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker
        uses: docker/setup-buildx-action@v2
      - name: Build and Start Home Test Database
        run: |
          docker compose \
          -f docker-compose.test-parallel.yml \
          up --detach home_db
      - name: Build Home Test Container
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          build home_tests
      - name: Run Home Tests
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          run --rm home_tests
      - name: Clean Up
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          down

  about_tests:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker
        uses: docker/setup-buildx-action@v2
      - name: Build and Start About Test Database
        run: |
          docker compose \
          -f docker-compose.test-parallel.yml \
          up --detach about_db
      - name: Build About Test Container
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          build about_tests
      - name: Run About Tests
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          run --rm about_tests
      - name: Clean Up
        run: |
          docker-compose \
          -f docker-compose.test-parallel.yml \
          down

  linter:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4
      - name: Setup NodeJS
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
      - name: Installing dependencies
        run: npm ci
      - name: Running linter
        run: npm run lint
